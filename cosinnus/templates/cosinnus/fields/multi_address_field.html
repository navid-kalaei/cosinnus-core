{% load i18n widget_tweaks cosinnus_tags %}

{% comment %}  
    Cosinnus Multi Address Field template. For use with the dynamic_fields type DYNAMIC_FIELD_TYPE_MULTI_ADDRESS.
    
    Parameters:
        - field: supply the formfield you want to render
        - *or* field_html: supply some html to be displayed inside the field. ``field`` can additionally be passed, but will only be used
                for error and optional status display
        - label: the <label> for the field
        - legend: a descriptive text, shown as an explanation for the field
        - placeholder: the field placeholder content
        
    Extra Options:
        - first: indicates this is the first field in the form, removing the top margin
        - large-field: removes the 40px height constraint and wraps around the content. used for larger (or smaller) fields
        - unstyled: will apply no styles to field-input, so that custom ``field_html`` is not affected by the default styles
        - field_classes: extra CSS classes to apply to the input area
        - extra_html: extra HTML that will be placed after the field
        - help_popup: if supplied, add a Help-Button next to the label which will popup a help field using the supplied id string
        - hide_optional: forces hiding the "(Optional)" label for non-required fields
{% endcomment %}

{% if label %}
	<div class="cosinnus-field">
	    <label>
	        {{ label }}
	        {% if field and not field.field.required and not required and not hide_optional and not SETTINGS.COSINNUS_FIELDS_SHOW_REQUIRED_INSTEAD_OPTIONAL %}
	            ({% trans "optional" context "written next to optional form fields" %})
	        {% endif %}
	        {% if show_required or SETTINGS.COSINNUS_FIELDS_SHOW_REQUIRED_INSTEAD_OPTIONAL and required or SETTINGS.COSINNUS_FIELDS_SHOW_REQUIRED_INSTEAD_OPTIONAL and field.field.required %}
	            <span class="required-label">{{ SETTINGS.COSINNUS_FIELDS_REQUIRED_LABEL }}</span>
	        {% endif %}
	        {% if help_popup %}
	            {% include 'cosinnus/common/help_button_for_popup.html' with help_text_id=help_popup %}
	        {% endif %}
	    </label>
	</div>
{% endif %}
    
{% if field or field_id %}{% captureas for_id %}{% if field %}{{ field.id_for_label }}{% else %}{{ field_id }}{% endif %}{% endcaptureas %}{% endif %}

<div class="row">
	<div id="{{ field.id_for_label }}-protofields" class="multi-address-field protofields col-md-6" data-counter="-1" style="display: none;">
	    {% for subfield_name, subfield_label in field.get_subfields_name_and_label %}
			<div class="cosinnus-field">
			    <div class="field-description no-select {{ legend_class }}">
			        {{ subfield_label }}
			    </div>
			    <div class="cosinnus-field-input regular-field">
			        <input type="text" id="{{ field.id_for_label }}-{{ subfield_name }}" 
		                 name="{{ field.html_name }}-{{ subfield_name }}" placeholder="{{ subfield_label }}">
			    </div>
			</div>
		{% endfor %}
		<div class="cosinnus-field">
		    <div class="cosinnus-field-input regular-field">
		        <input type="radio" id="{{ field.id_for_label }}-selector" name="{{ field.html_name }}-selector" value="">
		        <label for="{{ field.id_for_label }}-selector">
		            {{ subfield_label }}
				</label>
		    </div>
	    </div>
	    <div class="cosinnus-field">
	        <a href="#" class="multi-address-field-remove">{% trans "Remove this Address" %}</a>
	    </div>
	</div>
</div>

<div id="multi-address-field-spawn-anchor"></div>
<div class="cosinnus-field">
    <a href="#" class="multi-address-field-add">{% trans "Add an Address" %}</a>
</div>

<script type="text/javascript">
    var multiAddressFieldCounter = 0;
    
    var addMultiAddressField = function() {
        var cloned_fields = $("#{{ field.id_for_label }}-protofields").clone();
        cloned_fields
            .removeAttr('id')
            .attr('data-counter', multiAddressFieldCounter)
            .removeClass('protofields');
        cloned_fields.children('input[type="text"]').each(function(){
            var me = $(this);
            me.attr('id', me.attr('id') + '-' + String(multiAddressFieldCounter));
            me.attr('name', me.attr('name') + '-' + String(multiAddressFieldCounter));
        });
        cloned_fields.children('input[type="radio"]').each(function(){
            var me = $(this);
            me.attr('id', me.attr('id') + '-' + str(multiAddressFieldCounter));
            me.attr('value', String(multiAddressFieldCounter));
        });
        cloned_fields.show().insertBefore('#multi-address-field-spawn-anchor');
        multiAddressFieldCounter += 1;
    }
    
    $('.multi-address-field-add').on('click', function(){
        addMultiAddressField();
    });
    $('body').on('click', '.multi-address-field-remove', function(){
        $(this).parents('.multi-address-field:not(.protofields)').remove();
    });
</script>


